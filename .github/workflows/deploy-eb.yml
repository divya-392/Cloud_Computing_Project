name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::339712863414:role/Github_actions
        aws-region: eu-west-1

    - name: Zip Dockerrun
      run: |
        zip deploy.zip Dockerrun.aws.json

    - name: Upload to S3
      run: |
        aws s3 cp deploy.zip s3://elasticbeanstalk-eu-west-1-339712863414/catalog-service.zip

    - name: Create EB version
      run: |
        aws elasticbeanstalk create-application-version \
          --application-name catalog-service-eb \
          --version-label v-${{ github.run_number }} \
          --source-bundle S3Bucket=elasticbeanstalk-eu-west-1-339712863414,S3Key=catalog-service.zip

    - name: Deploy to EB
      run: |
        aws elasticbeanstalk update-environment \
          --environment-name catalog-service-eb-env \
          --version-label v-${{ github.run_number }}
